<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RPG Initiative Pro</title>
<style>
:root {
--bg-color: #0f172a;
--card-bg: #1e293b;
--accent: #f43f5e;
--text: #f1f5f9;
--secondary: #6366f1;
--effect-color: #38bdf8;
--player-color: #10b981;
--active-row: rgba(99, 102, 241, 0.3);
--gap: 25px;
}

body {
font-family: 'Inter', system-ui, sans-serif;
background-color: var(--bg-color);
color: var(--text);
margin: 0;
padding: 10px;
display: flex;
flex-direction: column;
align-items: center;
overflow-x: hidden;
}

.container { width: 100%; max-width: 500px; display: flex; flex-direction: column; }

.section {
background: var(--card-bg);
padding: 15px;
border-radius: 16px;
margin-bottom: var(--gap);
box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

h2 { text-align: center; color: var(--accent); margin-top: 0; text-transform: uppercase; font-size: 1rem; letter-spacing: 1px; }

.input-group { display: flex; gap: 8px; margin-bottom: 10px; }

input, select {
background: #0f172a;
border: 1px solid #334155;
color: white;
padding: 12px;
border-radius: 8px;
font-size: 1rem;
}

.btn-add { background: var(--accent); border: none; color: white; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; flex-grow: 1; }
.btn-dice { background: #475569; border: none; color: white; padding: 12px; border-radius: 8px; }

table { width: 100%; border-collapse: collapse; }
tr.active-turn { background-color: var(--active-row); border-left: 5px solid var(--secondary); }
td { padding: 10px 4px; border-bottom: 1px solid #334155; }
.drag-handle { cursor: grab; color: #475569; padding-right: 5px; font-size: 1.1rem; user-select: none; }
/* Optimiertes Feld f√ºr zweistellige Initiative */
.inline-init {
width: 48px; /* Perfekt f√ºr 2 Stellen */
padding: 6px 0;
background: #0f172a;
border: 1px solid #475569;
color: white;
text-align: center;
border-radius: 6px;
font-size: 1rem;
font-weight: bold;
-moz-appearance: textfield; /* Entfernt Spinner in Firefox */
}
/* Entfernt Spinner (Pfeile) in Chrome/Safari */
.inline-init::-webkit-outer-spin-button,
.inline-init::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

.is-persistent { color: var(--player-color); font-weight: bold; }
.controls { display: flex; gap: 4px; justify-content: flex-end; align-items: center; }
.btn-move { background: #334155; border: none; color: #94a3b8; padding: 7px; border-radius: 4px; font-size: 0.8rem; line-height: 1; }
.btn-del { background: transparent; border: 1px solid #ef4444; color: #ef4444; padding: 6px 10px; border-radius: 4px; }

.round-box {
background: var(--secondary);
padding: 15px;
border-radius: 16px;
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: var(--gap);
}

.round-info { font-size: 1.1rem; font-weight: bold; }
.btn-next { background: #10b981; border: none; color: white; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }

.effect-tag {
font-size: 0.7rem;
background: rgba(56, 189, 248, 0.2);
color: var(--effect-color);
padding: 2px 5px;
border-radius: 4px;
margin-left: 4px;
display: inline-block;
border: 1px solid rgba(56, 189, 248, 0.2);
}
</style>
</head>
<body>

<div class="container">
<div class="section">
<h2>‚öîÔ∏è Initiative</h2>
<div class="input-group">
<input type="text" id="name" placeholder="Charakter" style="flex:3;">
<input type="number" id="init" placeholder="Ini" style="width:65px;">
<button class="btn-dice" onclick="rollInit()">üé≤</button>
</div>
<div style="display:flex; gap:10px; align-items:center; margin-bottom: 15px;">
<label style="font-size: 0.85rem; cursor:pointer;"><input type="checkbox" id="persistent"> üõ°Ô∏è Gruppe</label>
<button class="btn-add" onclick="addCharacter()">HINZUF√úGEN</button>
</div>
<table id="draggableTable">
<tbody id="tableBody"></tbody>
</table>
</div>

<div class="round-box">
<div class="round-info">RUNDE: <span id="roundDisplay">1</span></div>
<button class="btn-next" onclick="nextTurn()">N√§chster Zug ‚ûî</button>
</div>

<div class="section">
<h2 style="color:var(--effect-color)">‚ú® Effekt f√ºr aktiven Charakter</h2>
<select id="spellSelect" onchange="useSpell()" style="width:100%; margin-bottom:10px;">
<option value="">-- Schnellwahl Spr√ºche --</option>
<option value="üõ°Ô∏è Segen">Segen (10 Rnd)</option>
<option value="‚ú® Schutz vor B√∂sem">Schutz vor B√∂sem (10 Rnd)</option>
<option value="‚ö° Hast">Hast (10 Rnd)</option>
<option value="üî• Brennend">Brennend (1 Rnd)</option>
<option value="üåÄ Bet√§ubt">Bet√§ubt (1 Rnd)</option>
<option value="üß™ Vergiftet">Vergiftet (1 Rnd)</option>
</select>
<div class="input-group">
<input type="text" id="effName" placeholder="Effekt-Name" style="flex:3;">
<input type="number" id="effDur" placeholder="Rnd" style="width:60px;">
<button class="btn-add" style="background:var(--effect-color)" onclick="addEffect()">OK</button>
</div>
<table id="effectTable">
<tbody id="effTableBody"></tbody>
</table>
</div>

<div style="width:100%; display:flex; flex-direction:column; gap:10px;">
<button onclick="endCombat()" class="btn-add" style="background:#3b82f6;">Kampf beenden</button>
<button onclick="clearAll()" style="background:transparent; border:none; color:#64748b; padding:10px; cursor:pointer; font-size: 0.8rem;">Alles zur√ºcksetzen</button>
</div>
</div>

<script>
let characters = JSON.parse(localStorage.getItem('rpg_init')) || [];
let effects = JSON.parse(localStorage.getItem('rpg_effects')) || [];
let currentRound = parseInt(localStorage.getItem('rpg_round')) || 1;
let activeIndex = parseInt(localStorage.getItem('rpg_active_idx')) || 0;

function save() {
localStorage.setItem('rpg_init', JSON.stringify(characters));
localStorage.setItem('rpg_effects', JSON.stringify(effects));
localStorage.setItem('rpg_round', currentRound);
localStorage.setItem('rpg_active_idx', activeIndex);
}

function rollInit() { document.getElementById('init').value = Math.floor(Math.random() * 20) + 1; }

function useSpell() {
const s = document.getElementById('spellSelect'), n = document.getElementById('effName'), d = document.getElementById('effDur');
if(s.value) {
n.value = s.value;
d.value = (s.value.includes("Segen") || s.value.includes("Schutz") || s.value.includes("Hast")) ? 10 : 1;
}
}

function updateTables() {
save();
document.getElementById('roundDisplay').innerText = currentRound;
const tChar = document.getElementById('tableBody');
tChar.innerHTML = '';
characters.forEach((c, i) => {
const row = document.createElement('tr');
row.draggable = true;
row.dataset.index = i;
if(i === activeIndex) row.className = 'active-turn';
const charEffects = effects.filter(e => e.ownerId === c.id);
const effectHtml = charEffects.map(e => `<span class="effect-tag">${e.name} (${e.duration})</span>`).join('');

row.innerHTML = `
<td class="drag-handle">‚ò∞</td>
<td><input type="number" class="inline-init" value="${c.init}" onfocus="this.select()" onchange="updateIni(${i}, this.value)"></td>
<td class="${c.persistent ? 'is-persistent' : ''}" style="width:100%; padding-left: 5px;">
${c.persistent ? 'üõ°Ô∏è ' : ''}${c.name} ${effectHtml}
</td>
<td class="controls">
<button class="btn-move" onclick="moveManual(${i},-1)">‚ñ≤</button>
<button class="btn-move" onclick="moveManual(${i},1)">‚ñº</button>
${!c.persistent ? `<button class="btn-del" onclick="removeChar(${i})">‚úï</button>` : ''}
</td>`;
row.addEventListener('dragstart', handleDragStart);
row.addEventListener('dragover', handleDragOver);
row.addEventListener('drop', handleDrop);
row.addEventListener('dragend', handleDragEnd);
tChar.appendChild(row);
});

const tEff = document.getElementById('effTableBody');
tEff.innerHTML = '';
effects.forEach((e, i) => {
const owner = characters.find(c => c.id === e.ownerId);
tEff.innerHTML += `<tr>
<td style="width:30px; color:var(--effect-color); font-weight:bold;">${e.duration}</td>
<td>${e.name} <small style="opacity:0.6;">(${owner ? owner.name : '?'})</small></td>
<td class="controls"><button class="btn-del" onclick="removeEff(${i})">‚úï</button></td>
</tr>`;
});
}

let dragSrcEl = null;
function handleDragStart(e) { dragSrcEl = this; e.dataTransfer.effectAllowed = 'move'; }
function handleDragOver(e) { if (e.preventDefault) e.preventDefault(); return false; }
function handleDrop(e) {
if (e.stopPropagation) e.stopPropagation();
const fromIdx = parseInt(dragSrcEl.dataset.index);
const toIdx = parseInt(this.dataset.index);
if (fromIdx !== toIdx) {
const item = characters.splice(fromIdx, 1)[0];
characters.splice(toIdx, 0, item);
updateTables();
}
return false;
}
function handleDragEnd() {}

function nextTurn() {
if(characters.length === 0) return;
const currentId = characters[activeIndex].id;
effects = effects.map(e => {
if(e.ownerId === currentId) return { ...e, duration: e.duration - 1 };
return e;
}).filter(e => e.duration > 0);
activeIndex++;
if (activeIndex >= characters.length) { activeIndex = 0; currentRound++; }
updateTables();
}

function addCharacter() {
const n = document.getElementById('name'), i = document.getElementById('init'), p = document.getElementById('persistent');
if(n.value && i.value) {
characters.push({ id: Date.now() + Math.random(), name: n.value, init: parseInt(i.value), persistent: p.checked });
characters.sort((a, b) => b.init - a.init);
n.value = ''; i.value = ''; p.checked = false;
updateTables();
}
}

function addEffect() {
const n = document.getElementById('effName'), d = document.getElementById('effDur');
if(n.value && d.value && characters[activeIndex]) {
effects.push({ name: n.value, duration: parseInt(d.value), ownerId: characters[activeIndex].id });
n.value = ''; d.value = '';
updateTables();
}
}

function updateIni(index, val) {
characters[index].init = parseInt(val) || 0;
characters.sort((a, b) => b.init - a.init);
updateTables();
}

function moveManual(index, dir) {
const newIdx = Math.max(0, Math.min(characters.length - 1, index + dir));
const item = characters.splice(index, 1)[0];
characters.splice(newIdx, 0, item);
updateTables();
}

function removeChar(i) { characters.splice(i, 1); updateTables(); }
function removeEff(i) { effects.splice(i, 1); updateTables(); }
function endCombat() {
if(confirm("Kampf beenden?")) {
characters = characters.filter(c => c.persistent).map(c => ({...c, init: 0}));
effects = []; currentRound = 1; activeIndex = 0;
updateTables();
}
}
function clearAll() { if(confirm("Alles l√∂schen?")) { localStorage.clear(); location.reload(); } }
updateTables();
</script>
</body>
</html>
